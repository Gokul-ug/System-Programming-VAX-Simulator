<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Linking Loader Simulator - Step by Step</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin:0; padding:20px;
    background:#1e1e2f; color:#ecf0f1;
}
h1 {text-align:center; margin-bottom:20px;}
h2 {color:#bdc3c7; margin:10px 0;}
.panels {display:flex; flex-wrap:wrap; gap:20px;}
.panel {
    flex:1 1 300px; min-width:280px; background:#2c2c3f;
    border-radius:10px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.3);
    display:flex; flex-direction:column; height:100%;
}
textarea, input {
    width:100%; padding:10px; border-radius:6px;
    border:1px solid #555; background:#1f1f2f; color:#ecf0f1; font-family:monospace; margin-top:5px;
}
button { padding:10px; border-radius:6px; border:none; background:#3498db; color:#fff; cursor:pointer; margin-top:10px;}
button:hover { background:#2980b9; }
#log, #estabTable, #relocTable { max-height:300px; overflow:auto; margin-top:10px; padding:10px; border:1px solid #555; border-radius:8px; background:#1f1f2f; font-family:monospace;}
table { width:100%; border-collapse:collapse; color:#ecf0f1;}
th, td { border:1px solid #555; padding:5px; text-align:center;}
th { background:#34495e;}
</style>
</head>
<body>

<h1>Linking Loader Simulator - Step by Step</h1>

<div class="panels">

<!-- Program Inputs -->
<div class="panel">
<h2>Program Inputs</h2>
<textarea id="progA" placeholder="Paste Program A object records here"></textarea>
<textarea id="progB" placeholder="Paste Program B object records here"></textarea>
<textarea id="progC" placeholder="Paste Program C object records here"></textarea>
<input type="text" id="loadAddr" placeholder="Single load address (hex)">
<button onclick="startSimulation()">Start Simulation</button>
<button onclick="stepSimulation()">Step</button>
</div>

<!-- ESTAB -->
<div class="panel">
<h2>External Symbol Table (ESTAB)</h2>
<div id="estabTable"></div>
</div>

<!-- Relocation Output -->
<div class="panel">
<h2>Relocation Output</h2>
<div id="relocTable"></div>
</div>

</div>

<div id="log"></div>

<script>
let programs=[], loadAddr=0, currentProg=0, lineIndex=0, ESTAB=[], relocOutput=[];
function hexToInt(hex){ return parseInt(hex,16); }
function intToHex(val,len=6){ return val.toString(16).toUpperCase().padStart(len,'0'); }
function log(msg){ document.getElementById('log').innerHTML += msg + "<br>"; }

function startSimulation(){
    programs = [
        document.getElementById('progA').value.split('\n').map(l=>l.trim()).filter(l=>l!==''),
        document.getElementById('progB').value.split('\n').map(l=>l.trim()).filter(l=>l!==''),
        document.getElementById('progC').value.split('\n').map(l=>l.trim()).filter(l=>l!=='')
    ];
    loadAddr = hexToInt(document.getElementById('loadAddr').value || '0');
    currentProg = 0;
    lineIndex = 0;
    ESTAB=[]; relocOutput=[];
    document.getElementById('log').innerHTML='';
    document.getElementById('estabTable').innerHTML='';
    document.getElementById('relocTable').innerHTML='';
    log(`Simulation started. All programs will be loaded at ${intToHex(loadAddr,4)}.`);
    updateESTAB(); updateReloc();
}

function stepSimulation(){
    if(currentProg >= programs.length){ log("All programs loaded."); return; }
    let prog = programs[currentProg];
    if(lineIndex >= prog.length){ 
        log(`Program ${String.fromCharCode(65+currentProg)} finished.`); 
        currentProg++; lineIndex=0; 
        return; 
    }
    let line = prog[lineIndex];
    lineIndex++;
    let parts = line.split('^'); 
    let rec = parts[0];
    let csAddr = loadAddr;

    if(rec === 'H'){
        let name = parts[1], addr = hexToInt(parts[2]), len = hexToInt(parts[3]);
        ESTAB.push({csname:name, extsym:'-', address:addr + csAddr, length:len});
        log(`Loaded Header Record: ${name}, Addr=${intToHex(addr + csAddr,4)}, Len=${intToHex(len,4)}`);
    } else if(rec === 'D'){
        while(lineIndex < prog.length && !['H','T','E','R'].includes(prog[lineIndex].split('^')[0])){
            let p = prog[lineIndex].split('^');
            for(let i=0;i<p.length;i+=2){
                let sym = p[i], addr = hexToInt(p[i+1]);
                ESTAB.push({csname:'-', extsym:sym, address:addr + csAddr, length:0});
                log(`Loaded Define Record: ${sym}, Addr=${intToHex(addr + csAddr,4)}`);
            }
            lineIndex++;
        }
    } else if(rec === 'T'){
        let textAddr = hexToInt(parts[1]), textLen = hexToInt(parts[2]);
        let objcodes = parts.slice(3);
        objcodes.forEach((code,k)=>{
            let orig = textAddr + k*3;
            let reloc = intToHex(hexToInt(code) + csAddr,6);
            relocOutput.push({orig:intToHex(orig,4), new:intToHex(csAddr+orig,4), code:code, reloc:reloc});
            log(`Relocated: Orig=${intToHex(orig,4)}, New=${intToHex(csAddr+orig,4)}, Code=${code}, Reloc=${reloc}`);
        });
    } else if(rec === 'E'){
        log(`End Record for Program ${String.fromCharCode(65+currentProg)} reached.`);
    }
    updateESTAB(); updateReloc();
}


function updateESTAB(){
    let html="<table><tr><th>CS_NAME</th><th>EXT_SYM</th><th>ADDRESS</th><th>LENGTH</th></tr>";
    ESTAB.forEach(e=>{ html+=`<tr><td>${e.csname}</td><td>${e.extsym}</td><td>${intToHex(e.address,4)}</td><td>${intToHex(e.length,4)}</td></tr>`; });
    html+="</table>"; document.getElementById('estabTable').innerHTML=html;
}

function updateReloc(){
    let html="<table><tr><th>Orig Addr</th><th>New Addr</th><th>Obj Code</th><th>Relocated</th></tr>";
    relocOutput.forEach(r=>{ html+=`<tr><td>${r.orig}</td><td>${r.new}</td><td>${r.code}</td><td>${r.reloc}</td></tr>`; });
    html+="</table>"; document.getElementById('relocTable').innerHTML=html;
}
</script>

</body>
</html>
